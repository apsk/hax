% \documentclass{article}
\documentclass[convert={density=400,size=640x480,outext=.png}]{standalone}
\usepackage{tikz}
\usetikzlibrary{calc}

\newcommand{\blockinput}[2]{
  \draw #1 -- #2;
  \draw[fill] #2 circle [radius=2pt];
}

\newcommand{\blockoutput}[2]{
  \draw #1 -- #2;
  \draw let
    \p1 = #1,
    \p2 = #2
  in
    \ifdim\y1=\y2
      ($ #1 + (0,.2) $) -- ($ #1 - (0,.2) $)
    \else
      ($ #1 + (.2,0) $) -- ($ #1 - (.2,0) $)
    \fi;
}

\newcommand{\parser}[1]{
  \draw [ultra thick] #1 rectangle ($ #1 + (5,-4) $);
  \node [below left] at ($ #1 + (5,0) $) {Parser};
  \blockinput{($ #1 + (-1,-1) $)}{($ #1 + (.5,-1) $)};
  \blockinput{($ #1 + (-1,-3) $)}{($ #1 + (.5,-3) $)};
  \blockoutput{($ #1 + (4.5,-2) $)}{($ #1 + (6,-2) $)};
}

\begin{document}
\begin{tikzpicture}[scale=0.5]
% lhs
\parser{(3,7)};
\node [above left, scale = 0.8] at (3,6) {reader};
\node [above left, scale = 0.8] at (3,4) {pool};
% mid
\draw [dotted,->] (8,5.5) -- (19.95,5.5);
\node [below, scale = 0.6] at (12,5.5) {HAX::pool};
% rhs
\parser{(20,7)};
\node [above left, scale = 0.8] at (16,6) {reader};
\node [above left, scale = 0.8] at (16,4) {pool};
\blockinput{(15,6)}{(20.5,6)};
% sel
\draw (17,3) rectangle (19,5);
\node [below, scale = 0.75] at (18,5) {Select};
\blockinput{(15,4)}{(17.5,4)};
\node [below left, scale = 0.5] at (17,4) {main};
\blockinput{(18,2)}{(18,3.5)};
\node [below left, scale = 0.5] at (18,3) {aux};
\blockoutput{(18.5,4)}{(20.5,4)};
% dup
\draw (26,4) rectangle (28,6);
\node [below, scale = 0.75] at (27,6) {Dup};
\blockinput{(25,5)}{(26.6,5)};
\blockoutput{(27.5,5)}{(30,5)};
\blockoutput{(27,4.5)}{(27,2)};
\draw (27,2) -- (18,2);
% outer
\draw [ultra thick] (16,1) rectangle (29,9);
\node [below left] at (29,9) {SelfPooledParser};

\end{tikzpicture}
\end{document}